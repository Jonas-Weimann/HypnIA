<!DOCTYPE html>
<html lang="es">
    <head>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <link rel="stylesheet" href="./assets/css/register-dream.css">
        <link rel="stylesheet" href="./assets/css/cartas-emociones.css">
        <link rel="preconnect" href="https://fonts.googleapis.com">
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@700&display=swap" rel="stylesheet">
        <link href="https://fonts.googleapis.com/css2?family=Raleway:wght@300&display=swap" rel="stylesheet">
        <title>Registra tu sueño</title>
    </head>
    <body>
        <div id="header"></div>
        <script src="./assets/js/header.js"></script>
        <main>
            <section class="registro-de-suenos">
                <div id="zona-interpretacion" class="zona-interpretacion">
                    <div class="publicacion">
                        <div class="perfil-nombre">
                            <a href="#"><img src="assets/images/perfil-default.webp" alt="Perfil">Nombre largo largo largo largo largo</a>
                        </div>
                        <div class="apartado-descripcion">
                            <h1>Descripción</h1>
                            <p>Lorem Ipsum Lorem Ipsum Lorem Ipsum Lorem Ipsum Lorem Ipsum Lorem Ipsum Lorem Ipsum Lorem Ipsum Lorem Ipsum Lorem Ipsum Lorem Ipsum </p>
                        </div>
                        <div class="apartado-interpretacion">
                            <h1>Interpretación</h1>
                            <p>Tu sueño de estar perdido en una balsa en medio del océano simboliza un viaje introspectivo y de autodescubrimiento. El océano, vasto y sin límites, representa tus emociones profundas y desconocidas, mientras que la balsa es un símbolo de tu yo consciente, navegando a través de estas aguas desconocidas. Este sueño puede estar sugiriendo que te sientes a la deriva en tu vida, sin un rumbo claro, y que estás luchando por encontrar tu camino y comprender tus emociones profundas. </p>
                        </div>
                    </div>
                    <div class="emociones-cartas-visibilidad">
                        <div class="zona-emociones">
                            <div class="emocion" style="background-image: url('assets/images/emociones/${emocion.intensidad}.webp'); backdrop-filter: blur(10px);">
                                <div class="nombre-emocion"><h2>${emocion.nombre.toUpperCase()}</h2></div>
                                <div class="informacion-emocion">
                                    <p><u>INTENSIDAD</u>: ${emocion.intensidad}</p>
                                    <p><u>POLARIDAD</u>: ${emocion.polaridad}</p>
                                </div>
                            </div>
                            <div class="emocion" style="background-image: url('assets/images/emociones/${emocion.intensidad}.webp'); backdrop-filter: blur(10px);">
                                <div class="nombre-emocion"><h2>${emocion.nombre.toUpperCase()}</h2></div>
                                <div class="informacion-emocion">
                                    <p><u>INTENSIDAD</u>: ${emocion.intensidad}</p>
                                    <p><u>POLARIDAD</u>: ${emocion.polaridad}</p>
                                </div>
                            </div>
                            <div class="emocion" style="background-image: url('assets/images/emociones/${emocion.intensidad}.webp'); backdrop-filter: blur(10px);">
                                <div class="nombre-emocion"><h2>${emocion.nombre.toUpperCase()}</h2></div>
                                <div class="informacion-emocion">
                                    <p><u>INTENSIDAD</u>: ${emocion.intensidad}</p>
                                    <p><u>POLARIDAD</u>: ${emocion.polaridad}</p>
                                </div>
                            </div>
                        </div>
                        <div class="zona-cartas-visibilidad">
                            <div class="zona-visibilidad"><h2>Visibilidad:</h2></div>

                            <div class="zona-cartas">
                                <div class="carta">
                                    <img id="imagen-carta" src="./assets/images/cartas/${carta.imagen}">
                                    <div class="nombre-carta"><h2>${carta.nombre}</h2></div>
                                    <div class="informacion-carta">
                                        <p><u>ELEMENTO</u>: ${carta.elemento}</p>
                                        <p><u>POLARIDAD</u>: ${carta.polaridad}</p>
                                        <p style="border-top: 1px solid white">${carta.descripcion}</p>
                                    </div>
                                </div>
                                <div class="carta">
                                    <img id="imagen-carta" src="./assets/images/cartas/${carta.imagen}">
                                    <div class="nombre-carta"><h2>${carta.nombre}</h2></div>
                                    <div class="informacion-carta">
                                        <p><u>ELEMENTO</u>: ${carta.elemento}</p>
                                        <p><u>POLARIDAD</u>: ${carta.polaridad}</p>
                                        <p style="border-top: 1px solid white">${carta.descripcion}</p>
                                    </div>
                                </div>
                                <div class="carta">
                                    <img id="imagen-carta" src="./assets/images/cartas/${carta.imagen}">
                                    <div class="nombre-carta"><h2>${carta.nombre}</h2></div>
                                    <div class="informacion-carta">
                                        <p><u>ELEMENTO</u>: ${carta.elemento}</p>
                                        <p><u>POLARIDAD</u>: ${carta.polaridad}</p>
                                        <p style="border-top: 1px solid white">${carta.descripcion}</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="zona-links">
                        <a href="">Perfil</a>
                        <a href="register-dream.html">Registra otro sueño</a>
                        <a href="#">Explora</a>
                        <a href="inicio.html">Inicio</a>
                    </div>
                </div>
                <div class="contenedor-form">
                <h1>DESCRIBE TU SUEÑO Y PRESIONA "INTERPRETAR"</h1>
                    <form action="http://localhost:3000/api/suenos" id="form-sueno" method="post">
                        <div class="form-descripcion">
                            <label for="descripcion">Aségurate de ser descriptivo:</label>
                            <textarea id="descripcion" name="descripcion" required></textarea>
                        </div>
                        <div class="form-visibilidad">
                            <img id="candado" src="assets/images/sueno-privado.webp" alt="Candado cerrado">
                            <p id="form-mensaje">Tu sueño permanecerá en privado y solo tú podrás verlo<br/>
                                Presiona el candado para cambiar la visibilidad de tu sueño</p>
                        </div>
                        <div class="form-boton">
                            <button type="submit" class="boton-interpretar"><h2>INTERPRETAR<h2></button>
                        </div>
                        <div id="mensaje-descripcion"></div>

                        <div id="spinner" class="spinner oculto">
                            <img class="cargando" src="./assets/images/luna-logo-header.webp">
                            <h2>Estamos interpretando tu sueño... <br/></h2>
                            <p>Recordá que la IA puede fallar. <br/>
                                Si eso pasa, no te preocupes. <br/>
                                ¡Podés intentarlo otra vez!</p>
                        </div>

                        <div id="mensaje-resultado" class="mensaje-resultado oculto"></div>

                        
                    </form>
                </div>
            </section>

            <div id="footer"></div>
            <script src="./assets/js/footer.js"></script>
        </main>
    </body>
    <script>
        const token = localStorage.getItem("token")
        console.log(token);
        const spinner = document.getElementById("spinner");
        const mensaje = document.querySelector(".mensaje-resultado");
        const zonaInterpretacion = document.querySelector(".zona-interpretacion");

        let esPublico = false;

        document.addEventListener("DOMContentLoaded", () => {
            const token = localStorage.getItem("token");
            if (!token) {
                const textarea = document.getElementById("descripcion");
                const formVisibilidad = document.querySelector(".form-visibilidad");
                const formBoton = document.querySelector(".form-boton");
                
                if (textarea) {
                textarea.disabled = true;
                textarea.placeholder = "No puedes escribir aquí, así lo ha dictado el maravilloso mundo onírico.";
                textarea.style.opacity = "0.3";
                }
                if (formVisibilidad) {
                formVisibilidad.innerHTML = `
                <a href="inicio.html"><img src="assets/images/luna-logo-header.webp" alt="Luna animada"></a>
                <p>Para que el múndo onírico acepte interpretar tus sueños,<br/>
                    debes iniciar sesión o crearte una cuenta.</p>
                `;
                }
                if (formBoton) {
                formBoton.innerHTML = `
                <a href="login.html" class="redireccion"><h2>INICIAR SESIÓN</h2></a>
                <a href="register.html" class="redireccion"><h2>REGISTRARSE</h2></a>
                `;
                }
            }
        });

        document.addEventListener("DOMContentLoaded", () => {
            const token = localStorage.getItem("token");
            if(token) {
                const candado = document.getElementById('candado');
                const mensaje = document.getElementById('form-mensaje');
                if (!mensaje || !candado) return;

                candado.addEventListener('click', () => {
                    esPublico = !esPublico;

                    if (esPublico) {
                    candado.src = 'assets/images/sueno-publico.webp';
                    candado.alt = 'Candado abierto';
                    mensaje.innerHTML = 'Tu sueño será público y otras personas podrán verlo<br/>Presiona el candado para cambiar la visibilidad de tu sueño';
                    } else {
                    candado.src = 'assets/images/sueno-privado.webp';
                    candado.alt = 'Candado cerrado';
                    mensaje.innerHTML = 'Tu sueño permanecerá en privado y solo tú podrás verlo<br/>Presiona el candado para cambiar la visibilidad de tu sueño';
                    }
                });
            }
        });

        const checkDescriptionLength = (descripcion) => {
			let mensajeDescripcion = document.getElementById("mensaje-descripcion");
            if(!mensajeDescripcion || !descripcion) return false;

			if (descripcion.length < 40) {
                mensajeDescripcion.innerHTML =
                    "Para asegurar que la IA pueda darte una buena interpretración <br/> la descripción de tu sueño debe tener más de 40 letras.<br/>";
                mensajeDescripcion.style.color = "red";
                return false;
			}
			if (descripcion.length > 400) {
                mensajeDescripcion.innerHTML =
                    "La descripción de tu sueño debe tener menos de 400 letras.<br/>";
                mensajeDescripcion.style.color = "red";
                return false;
			}

			mensajeDescripcion.innerHTML = "";
			return true;
		};

        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("form-sueno");
            if (!form) return;

		    form.addEventListener("submit", async (e) => {
                e.preventDefault();
                const token = localStorage.getItem("token");      
                const descripcion = document.getElementById("descripcion").value;
                const publico = esPublico;
                if (!checkDescriptionLength(descripcion) || !mensaje || !token) return;

                try {
                    spinner.classList.remove("oculto");
                    const respuesta = await fetch("http://localhost:3000/api/suenos", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${token}`
                    },
                        body: JSON.stringify({
                        descripcion,
                        publico
                        })
                    });

                const resultado = await respuesta.json();
                if (respuesta.ok) {
                    mensaje.classList.remove("oculto");;
                    mensaje.innerHTML =
                    "<h2>¡Se ha registrado tu sueño con éxito!</h2> <p>Las estrellas continúan brillando en el cielo nocturno</p>";
                    setTimeout(() => {
                        mensaje.classList.add("oculto");
                    }, 3000);
                    // mostrarInterpretacion();
                } else {
                    mensaje.classList.remove("oculto");
                    mensaje.innerHTML =
                    "<h2>Ocurrió un error al registrar tu sueño</h2><p>Las puertas del mundo onírico a veces se atascan...</p>";
                    setTimeout(() => {
                        mensaje.classList.add("oculto");
                        window.location.reload();
                    }, 3000);
                }
                } catch (error) {
                    mensaje.classList.remove("oculto");
                    mensaje.innerHTML =
                    "<h2>Error interno</h2><p>Algo explotó en la dimensión del servidor.<br/>Estamos tratando de recomponer el tejido de la realidad.</p>";
                    setTimeout(() => {
                        mensaje.classList.add("oculto");
                        window.location.reload();
                    }, 3000);
                } finally {
                    spinner.classList.add("oculto");
                }
		    });
        });

        const mostrarInterpretacion = () => {
            zonaInterpretacion.classList.remove("oculto");

            zonaInterpretacion.innerHTML = `
                <div class="sueno-guardado">
                    <p><strong>Fecha:</strong> ${sueno.fecha}</p>
                    <p><strong>Descripción:</strong> ${sueno.descripcion}</p>
                    <p><strong>Interpretación IA:</strong> ${sueno.interpretacion}</p>
                </div>
            `;
        };

    </script>
</html>